{"pageProps":{"post":{"title":"在WebGL中使用射线选择模型","date":1534877523000,"slug":"ray-casting-selecting","content":"<p><a href=\"https://arthas.me/demo/ray-casting/index.html\">DEMO</a></p>\n<h2>思路</h2>\n<p>首先要用到摄像机的位置、方向和鼠标在屏幕上的位置来得到射线的起点和方向，然后用得到的射线和模型的每个三角形测试来判断模型是否被选中。</p>\n<h2>构建射线</h2>\n<p>先实现简单的射线类：</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\"><span class=\"token maybe-class-name\">Ray</span></span><span class=\"token punctuation\">(</span><span class=\"token parameter\">position<span class=\"token punctuation\">,</span> direction</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">position</span> <span class=\"token operator\">=</span> position\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">direction</span> <span class=\"token operator\">=</span> direction\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>通过<code class=\"language-unknown\">camera.position</code>和<code class=\"language-unknown\">camera.front</code>可以直接得到一个以摄像机为原地，朝向摄像机正前方的射线。\n然后，根据摄像机的 fov 和鼠标的位置坐标可以计算出鼠标所指方向偏离中心的 x 轴和 y 轴角度。</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\">argl<span class=\"token punctuation\">.</span><span class=\"token property-access\">canvas</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mousemove'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token arrow operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> angleY <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token property-access\">offsetY</span> <span class=\"token operator\">*</span> camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">zoom</span> <span class=\"token operator\">/</span> argl<span class=\"token punctuation\">.</span><span class=\"token property-access\">options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">height</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">zoom</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> zoomX <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">zoom</span> <span class=\"token operator\">/</span> argl<span class=\"token punctuation\">.</span><span class=\"token property-access\">options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">height</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> argl<span class=\"token punctuation\">.</span><span class=\"token property-access\">options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">width</span>\n  <span class=\"token keyword\">let</span> angleX <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token property-access\">offsetX</span> <span class=\"token operator\">*</span> zoomX <span class=\"token operator\">/</span> argl<span class=\"token punctuation\">.</span><span class=\"token property-access\">options</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">width</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>zoomX <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>接下来，再将朝向摄像机正前方的向量在<code class=\"language-unknown\">camera.front</code>和<code class=\"language-unknown\">camera.right</code>两个向量所在的平面中旋转<code class=\"language-unknown\">angleX</code>度，再在旋转后的向量和<code class=\"language-unknown\">camera.up</code>两个向量所在的平面中旋转<code class=\"language-unknown\">angleY</code>度，就得到了鼠标所指向的方向。</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> normalFR <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nglm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">cross</span><span class=\"token punctuation\">(</span>normalFR<span class=\"token punctuation\">,</span> camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">front</span><span class=\"token punctuation\">,</span> camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">right</span><span class=\"token punctuation\">)</span>\nglm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">normalize</span><span class=\"token punctuation\">(</span>normalFR<span class=\"token punctuation\">,</span> normalFR<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> direction <span class=\"token operator\">=</span> <span class=\"token function\">rotateVec</span><span class=\"token punctuation\">(</span>camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">front</span><span class=\"token punctuation\">,</span> normalFR<span class=\"token punctuation\">,</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">glMatrix</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">toRadian</span><span class=\"token punctuation\">(</span>angleX<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">let</span> normalFU <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nglm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">cross</span><span class=\"token punctuation\">(</span>normalFU<span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">,</span> camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">up</span><span class=\"token punctuation\">)</span>\nglm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">normalize</span><span class=\"token punctuation\">(</span>normalFU<span class=\"token punctuation\">,</span> normalFU<span class=\"token punctuation\">)</span>\n\ndirection <span class=\"token operator\">=</span> <span class=\"token function\">rotateVec</span><span class=\"token punctuation\">(</span>direction<span class=\"token punctuation\">,</span> normalFU<span class=\"token punctuation\">,</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">glMatrix</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">toRadian</span><span class=\"token punctuation\">(</span>angleY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">//平面内向量的旋转，normal为平面的法线，angle为旋转角度</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">rotateVec</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">vec<span class=\"token punctuation\">,</span> normal<span class=\"token punctuation\">,</span> angle</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> direction <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> t1 <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> t2 <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">normalize</span><span class=\"token punctuation\">(</span>normal<span class=\"token punctuation\">,</span> normal<span class=\"token punctuation\">)</span>\n\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">scale</span><span class=\"token punctuation\">(</span>t1<span class=\"token punctuation\">,</span> vec<span class=\"token punctuation\">,</span> <span class=\"token known-class-name class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">cos</span><span class=\"token punctuation\">(</span>angle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">cross</span><span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">,</span> normal<span class=\"token punctuation\">,</span> vec<span class=\"token punctuation\">)</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">scale</span><span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">,</span> t2<span class=\"token punctuation\">,</span> <span class=\"token known-class-name class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">sin</span><span class=\"token punctuation\">(</span>angle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">add</span><span class=\"token punctuation\">(</span>direction<span class=\"token punctuation\">,</span> t1<span class=\"token punctuation\">,</span> t2<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword control-flow\">return</span> direction\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>然后就可以构建所需射线了：</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> ray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Ray</span><span class=\"token punctuation\">(</span>camera<span class=\"token punctuation\">.</span><span class=\"token property-access\">position</span><span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h2>射线三角形相交检测算法</h2>\n<p>使用的算法为<a href=\"https://en.wikipedia.org/wiki/M%C3%B6ller%E2%80%93Trumbore_intersection_algorithm\">Möller–Trumbore intersection algorithm</a></p>\n<p>js 实现如下, 我将其作为 Ray 类的一个方法：</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Ray</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">prototype</span><span class=\"token punctuation\">.</span><span class=\"token method-variable function-variable method function property-access\">intersectsTriangle</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">triangle</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token constant\">EPSILON</span> <span class=\"token operator\">=</span> <span class=\"token number\">0.0000001</span>\n  <span class=\"token keyword\">let</span> edge1 <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> edge2 <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> h <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> s <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> q <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> a<span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">,</span> u<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">,</span> t\n  <span class=\"token keyword\">let</span> temp <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">sub</span><span class=\"token punctuation\">(</span>edge1<span class=\"token punctuation\">,</span> triangle<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> triangle<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">sub</span><span class=\"token punctuation\">(</span>edge2<span class=\"token punctuation\">,</span> triangle<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> triangle<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">cross</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">direction</span><span class=\"token punctuation\">,</span> edge2<span class=\"token punctuation\">)</span>\n  a <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">dot</span><span class=\"token punctuation\">(</span>edge1<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token constant\">EPSILON</span> <span class=\"token operator\">&#x26;&#x26;</span> a <span class=\"token operator\">&#x3C;</span> <span class=\"token constant\">EPSILON</span><span class=\"token punctuation\">)</span> <span class=\"token keyword control-flow\">return</span> <span class=\"token boolean\">false</span>\n  f <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">/</span> a\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">sub</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">position</span><span class=\"token punctuation\">,</span> triangle<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  u <span class=\"token operator\">=</span> f <span class=\"token operator\">*</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">dot</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> h<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>u <span class=\"token operator\">&#x3C;</span> <span class=\"token number\">0.0</span> <span class=\"token operator\">||</span> u <span class=\"token operator\">></span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword control-flow\">return</span> <span class=\"token boolean\">false</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">cross</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> edge1<span class=\"token punctuation\">)</span>\n  v <span class=\"token operator\">=</span> f <span class=\"token operator\">*</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">dot</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">direction</span><span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>v <span class=\"token operator\">&#x3C;</span> <span class=\"token number\">0.0</span> <span class=\"token operator\">||</span> u <span class=\"token operator\">+</span> v <span class=\"token operator\">></span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword control-flow\">return</span> <span class=\"token boolean\">false</span>\n  <span class=\"token comment\">// At this stage we can compute t to find out where the intersection point is on the line.</span>\n  t <span class=\"token operator\">=</span> f <span class=\"token operator\">*</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">dot</span><span class=\"token punctuation\">(</span>edge2<span class=\"token punctuation\">,</span> q<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">></span> <span class=\"token constant\">EPSILON</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ray intersection</span>\n    <span class=\"token keyword\">let</span> <span class=\"token maybe-class-name\">IntersectionPoint</span> <span class=\"token operator\">=</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">scale</span><span class=\"token punctuation\">(</span>temp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">direction</span><span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">)</span>\n    glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">add</span><span class=\"token punctuation\">(</span><span class=\"token maybe-class-name\">IntersectionPoint</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">position</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">direction</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword control-flow\">return</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token comment\">// This means that there is a line intersection but not a ray intersection.</span>\n  <span class=\"token keyword control-flow\">else</span> <span class=\"token keyword control-flow\">return</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>检测射线与模型是否相交</h2>\n<p>通过循环，使用<code class=\"language-unknown\">mesh.indices</code>和<code class=\"language-unknown\">mesh.vertices</code>中的数据来构建每一个三角形，再将其坐标变换到世界空间，然后检测他们是否与射线相交</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> flag <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token keyword\">let</span> len <span class=\"token operator\">=</span> suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">indices</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">length</span>\n\n<span class=\"token keyword control-flow\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&#x3C;</span> len<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">indices</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">indices</span><span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">indices</span><span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">let</span> triangle <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">transformMat4</span><span class=\"token punctuation\">(</span>\n    triangle<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    model\n  <span class=\"token punctuation\">)</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">transformMat4</span><span class=\"token punctuation\">(</span>\n    triangle<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    model\n  <span class=\"token punctuation\">)</span>\n  glm<span class=\"token punctuation\">.</span><span class=\"token property-access\">vec3</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">transformMat4</span><span class=\"token punctuation\">(</span>\n    triangle<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      suzanneMesh<span class=\"token punctuation\">.</span><span class=\"token property-access\">vertices</span><span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    model\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>ray<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">intersectsTriangle</span><span class=\"token punctuation\">(</span>triangle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    flag <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>然后即可利用布尔值<code class=\"language-unknown\">flag</code>来添加是否选中模型的效果了，demo 中选中时模型变成红色。</p>\n<h2>完整代码</h2>\n<p><a href=\"https://github.com/Deadalusmask/ArGL/tree/master/examples/pick_test\">Deadalusmask/ArGL/examples/pick_test</a></p>\n<p><a href=\"https://arthas.me/demo/ray-casting/index.html\">DEMO</a></p>"},"prev":{"slug":"Graphic-Basics-3","title":"Graphic Basics 3 着色器","date":1525119270000},"next":{"slug":"global-state-with-hooks","title":"Global state with hooks","date":1562871240000}},"__N_SSG":true}