{"pageProps":{"post":{"title":"新浪微博登录第三方应用","date":1509204819000,"slug":"weibo-third-party-login","content":"<p>通过观察网易云音乐使用微博登录时跳转的页面<a href=\"https://api.weibo.com/oauth2/authorize?client_id=301575942&#x26;response_type=code&#x26;redirect_uri=http://music.163.com/back/weibo&#x26;forcelogin=true&#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog\">应用授权-网易云音乐</a>，在微博账号的输入栏被填写并失去焦点后，会发送一个到 prelogin.php 的请求，请求的 url 为</p>\n<div class=\"remark-highlight\"><pre class=\"language-txt\"><code class=\"language-txt\">https://login.sina.com.cn/sso/prelogin.php?entry=openapi&#x26;amp;callback=sinaSSOController.preloginCallBack&#x26;amp;su=MTEx&#x26;amp;rsakt=mod&#x26;amp;checkpin=1&#x26;amp;client=ssologin.js(v1.4.18)&#x26;amp;_=1509178064363</code></pre></div>\n<p>其中请求参数<code class=\"language-unknown\">su</code>为 base64 编码的账号字符串，<code class=\"language-unknown\">_</code>为当前时间，这里用<code class=\"language-unknown\">int(time.time()*1000)</code>生成。</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">start_requests</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    username_quote <span class=\"token operator\">=</span> urllib<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">.</span>quote_plus<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">)</span>\n    username_base64 <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64encode<span class=\"token punctuation\">(</span>username_quote<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    su <span class=\"token operator\">=</span>  username_base64<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span>\n    prelogin_url <span class=\"token operator\">=</span> <span class=\"token string\">'https://login.sina.com.cn/sso/prelogin.php?entry=openapi&#x26;callback=sinaSSOController.preloginCallBack&#x26;su=%s&#x26;rsakt=mod&#x26;checkpin=1&#x26;client=ssologin.js(v1.4.18)&#x26;_=%s'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>su<span class=\"token punctuation\">,</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>scrapy<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">(</span>prelogin_url<span class=\"token punctuation\">,</span>headers<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>meta<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"cookiejar\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>callback<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>login_request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n</code></pre></div>\n<p>请求的返回结果为：</p>\n<div class=\"remark-highlight\"><pre class=\"language-js\"><code class=\"language-js\">sinaSSOController<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">preloginCallBack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  retcode<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  servertime<span class=\"token operator\">:</span> <span class=\"token number\">1509178513</span><span class=\"token punctuation\">,</span>\n  pcid<span class=\"token operator\">:</span> <span class=\"token string\">\"yf-db7f8e82296bf55717be22d63e61976356da\"</span><span class=\"token punctuation\">,</span>\n  nonce<span class=\"token operator\">:</span> <span class=\"token string\">\"8GLRMV\"</span><span class=\"token punctuation\">,</span>\n  pubkey<span class=\"token operator\">:</span>\n    <span class=\"token string\">\"EB2A38568661887FA180BDDB5CABD5F21C7BFD59C090CB2D245A87AC253062882729293E5506350508E7F9AA3BB77F4333231490F915F6D63C55FE2F08A49B353F444AD3993CACC02DB784ABBB8E42A9B1BBFFFB38BE18D78E87A0E41B9B8F73A928EE0CCEE1F6739884B9777E4FE9E88A1BBE495927AC4A799B3181D6442443\"</span><span class=\"token punctuation\">,</span>\n  rsakv<span class=\"token operator\">:</span> <span class=\"token string\">\"1330428213\"</span><span class=\"token punctuation\">,</span>\n  is_openlock<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  showpin<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  exectime<span class=\"token operator\">:</span> <span class=\"token number\">23</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>使用以下代码将其中的参数转换为一个 python 的 dict:</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\">res <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"sinaSSOController.preloginCallBack\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    server_data <span class=\"token operator\">=</span> <span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>使用得到的<code class=\"language-unknown\">servertime</code>、<code class=\"language-unknown\">nonce</code>和<code class=\"language-unknown\">pubkey</code>参数得出 RSA 加密后的密码：</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\">rsaPublickey <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>server_data<span class=\"token punctuation\">[</span><span class=\"token string\">'pubkey'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n    key <span class=\"token operator\">=</span> rsa<span class=\"token punctuation\">.</span>PublicKey<span class=\"token punctuation\">(</span>rsaPublickey<span class=\"token punctuation\">,</span> <span class=\"token number\">65537</span><span class=\"token punctuation\">)</span>\n    message <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>server_data<span class=\"token punctuation\">[</span><span class=\"token string\">'servertime'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'\\t'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>server_data<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'\\n'</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span>\n    message <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span>\n    passwd <span class=\"token operator\">=</span> rsa<span class=\"token punctuation\">.</span>encrypt<span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n    passwd <span class=\"token operator\">=</span> binascii<span class=\"token punctuation\">.</span>b2a_hex<span class=\"token punctuation\">(</span>passwd<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>然后就可以发送登录请求了：</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\">login_url <span class=\"token operator\">=</span> <span class=\"token string\">'https://login.sina.com.cn/sso/login.php?client=ssologin.js(v1.4.18)&#x26;_=%s&#x26;openapilogin=qrcode'</span> <span class=\"token operator\">%</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nscrapy<span class=\"token punctuation\">.</span>FormRequest<span class=\"token punctuation\">(</span>\n    login_url<span class=\"token punctuation\">,</span>\n    meta<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'cookiejar'</span><span class=\"token punctuation\">:</span> response<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">[</span><span class=\"token string\">'cookiejar'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    headers<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\n    formdata<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'entry'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'openapi'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'gateway'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'from'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'savestate'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'useticket'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'pagerefer'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'http://music.163.com/'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'ct'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'1800'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'s'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'vsnf'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'vsnval'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'door'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'appkey'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'u6BYq'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'su'</span><span class=\"token punctuation\">:</span>self<span class=\"token punctuation\">.</span>get_su<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'service'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'miniblog'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'servertime'</span><span class=\"token punctuation\">:</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>server_data<span class=\"token punctuation\">[</span><span class=\"token string\">'servertime'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'nonce'</span><span class=\"token punctuation\">:</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>server_data<span class=\"token punctuation\">[</span><span class=\"token string\">'nonce'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'pwencode'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'rsa2'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'rsakv'</span><span class=\"token punctuation\">:</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>server_data<span class=\"token punctuation\">[</span><span class=\"token string\">'rsakv'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'sp'</span><span class=\"token punctuation\">:</span>passwd<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'sr'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'1366*768'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'encoding'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'UTF-8'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'cdult'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'domain'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'weibo.com'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'prelt'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'55'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'returntype'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'TEXT'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    callback<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>authorize_request<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>然后是对网易云音乐的授权，请求表单需要提供登录成功返回的<code class=\"language-unknown\">ticket</code>值：</p>\n<div class=\"remark-highlight\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">authorize_request</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    response_json <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n    authorize_url <span class=\"token operator\">=</span> <span class=\"token string\">'https://api.weibo.com/oauth2/authorize'</span>\n    <span class=\"token keyword\">return</span> scrapy<span class=\"token punctuation\">.</span>FormRequest<span class=\"token punctuation\">(</span>authorize_url<span class=\"token punctuation\">,</span>\n        headers<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\n        meta<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'cookiejar'</span><span class=\"token punctuation\">:</span> response<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">[</span><span class=\"token string\">'cookiejar'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        formdata<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'action'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'login'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'display'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'default'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'withOfficalFlag'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'quick_auth'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'false'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'withOfficalAccount'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'scope'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'ticket'</span><span class=\"token punctuation\">:</span>response_json<span class=\"token punctuation\">[</span><span class=\"token string\">'ticket'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'isLoginSina'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'response_type'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'regCallback'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'https://api.weibo.com/oauth2/authorize?client_id=301575942&#x26;response_type=code&#x26;redirect_uri=http://music.163.com/back/weibo&#x26;forcelogin=true&#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'redirect_uri'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'http://music.163.com/back/weibo'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'client_id'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'301575942'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'appkey62'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'u6BYq'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'state'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'verifyToken'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'null'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'from'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'switchLogin'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'userId'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">:</span><span class=\"token string\">''</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        callback<span class=\"token operator\">=</span>do_something<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>授权成功后会跳转到<code class=\"language-unknown\">http://music.163.com/back/sns</code>,返回了网易云音乐用户的 uid 和一些信息，大功告成~</p>"},"prev":{"slug":"Laravel-passport-for-api-auth","title":"使用laravel/passport的客户端api认证","date":1477604930000},"next":{"slug":"winter-vacation-daily","title":"寒假日常","date":1519837064000}},"__N_SSG":true}