{"pageProps":{"post":{"title":"使用laravel/passport的客户端api认证","date":1477604930000,"slug":"Laravel-passport-for-api-auth","content":"<h3>根据官方文档安装 passport</h3>\n<p>在执行<code>passport:install</code>时 passport 已经创建了 id 为 2 的密码发放客户端;</p>\n<h3>用 js 消费 api</h3>\n<p>用 js 请求<code>/oauth/token</code>来获取<code>access_token</code>和<code>refresh_token</code>;</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-function\"><span class=\"hljs-title\">login</span>(<span class=\"hljs-params\"></span>)</span> {\r\n  <span class=\"hljs-keyword\">const</span> data = {\r\n    <span class=\"hljs-attr\">grant_type</span>: <span class=\"hljs-string\">'password'</span>,\r\n    <span class=\"hljs-attr\">client_id</span>: <span class=\"hljs-number\">2</span>,\r\n    <span class=\"hljs-attr\">client_secret</span>: 数据库中的secret值,\r\n    <span class=\"hljs-attr\">username</span>: $(<span class=\"hljs-string\">\"#username\"</span>).val(),\r\n    <span class=\"hljs-attr\">password</span>: $(<span class=\"hljs-string\">\"#password\"</span>).val(),\r\n    <span class=\"hljs-attr\">scope</span>: <span class=\"hljs-string\">'*'</span>\r\n  }\r\n\r\n  <span class=\"hljs-built_in\">this</span>.$http.post(<span class=\"hljs-string\">'/oauth/token'</span>, <span class=\"hljs-built_in\">JSON</span>.stringify(data))\r\n    .then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =></span>{\r\n      <span class=\"hljs-built_in\">console</span>.log(response.data.access_token)\r\n      Cookies.set(<span class=\"hljs-string\">'api_token'</span>,response.data.access_token)\r\n    })\r\n    .catch(<span class=\"hljs-built_in\">console</span>.error)\r\n},</code></pre>\n<p>将获取到的 api_token 添加到 header 的<code>Authorization</code>中，</p>\n<p>设置其值为<code>Bearer TOKEN</code>， 其中 TOKEN 是<code>api_token</code>的值，</p>\n<p>其中 Bearer 表示令牌类型。</p>\n<h3>路由</h3>\n<p>在<code>routes/api.php</code>中添加</p>\n<pre><code class=\"hljs language-php\">Route::get(<span class=\"hljs-string\">'/test'</span>,<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>)</span>{\r\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">'success'</span>;\r\n})->middleware(<span class=\"hljs-string\">'auth:api'</span>);</code></pre>\n<h3>JS</h3>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-function\"><span class=\"hljs-title\">test</span>(<span class=\"hljs-params\"></span>)</span> {\r\n  <span class=\"hljs-built_in\">this</span>.$http.get(<span class=\"hljs-string\">'/api/test'</span>,{\r\n    <span class=\"hljs-attr\">headers</span>:{\r\n      <span class=\"hljs-string\">'Authorization'</span> : <span class=\"hljs-string\">'Bearer '</span>+ Cookies.get(<span class=\"hljs-string\">'api_token'</span>),\r\n    }\r\n  }).then(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =></span>{\r\n    <span class=\"hljs-built_in\">this</span>.msg = response.data\r\n  }, <span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =></span> {\r\n    <span class=\"hljs-built_in\">this</span>.msg = <span class=\"hljs-string\">'failed'</span>\r\n  })\r\n},</code></pre>"},"prev":{"slug":"Archlinux-note-2","title":"Archlinux笔记(三)","date":1461147759000},"next":{"slug":"weibo-third-party-login","title":"新浪微博登录第三方应用","date":1509204819000}},"__N_SSG":true}