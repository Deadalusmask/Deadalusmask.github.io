{"pageProps":{"post":{"title":"新浪微博登录第三方应用","date":1509204819000,"slug":"weibo-third-party-login","content":"<p>通过观察网易云音乐使用微博登录时跳转的页面<a href=\"https://api.weibo.com/oauth2/authorize?client_id=301575942&#x26;response_type=code&#x26;redirect_uri=http://music.163.com/back/weibo&#x26;forcelogin=true&#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog\">应用授权-网易云音乐</a>，在微博账号的输入栏被填写并失去焦点后，会发送一个到 prelogin.php 的请求，请求的 url 为</p>\n<p><code>https://login.sina.com.cn/sso/prelogin.php?entry=openapi&#x26;callback=sinaSSOController.preloginCallBack&#x26;su=MTEx&#x26;rsakt=mod&#x26;checkpin=1&#x26;client=ssologin.js(v1.4.18)&#x26;_=1509178064363</code></p>\n<p>其中请求参数<code>su</code>为 base64 编码的账号字符串，<code>_</code>为当前时间，这里用<code>int(time.time()*1000)</code>生成。</p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">start_requests</span>(<span class=\"hljs-params\">self</span>):</span>\r\n    username_quote = urllib.parse.quote_plus(self.username)\r\n    username_base64 = base64.b64encode(username_quote.encode(<span class=\"hljs-string\">\"utf-8\"</span>))\r\n    su =  username_base64.decode(<span class=\"hljs-string\">\"utf-8\"</span>)\r\n    prelogin_url = <span class=\"hljs-string\">'https://login.sina.com.cn/sso/prelogin.php?entry=openapi&#x26;callback=sinaSSOController.preloginCallBack&#x26;su=%s&#x26;rsakt=mod&#x26;checkpin=1&#x26;client=ssologin.js(v1.4.18)&#x26;_=%s'</span> % (su,<span class=\"hljs-built_in\">str</span>(<span class=\"hljs-built_in\">int</span>(time.time())))\r\n    <span class=\"hljs-keyword\">return</span> [scrapy.Request(prelogin_url,headers=self.headers,meta={<span class=\"hljs-string\">\"cookiejar\"</span>: <span class=\"hljs-number\">1</span>},callback=self.login_request)]</code></pre>\n<p>请求的返回结果为：</p>\n<pre><code class=\"hljs language-js\">sinaSSOController.preloginCallBack({\r\n  <span class=\"hljs-attr\">retcode</span>: <span class=\"hljs-number\">0</span>,\r\n  <span class=\"hljs-attr\">servertime</span>: <span class=\"hljs-number\">1509178513</span>,\r\n  <span class=\"hljs-attr\">pcid</span>: <span class=\"hljs-string\">\"yf-db7f8e82296bf55717be22d63e61976356da\"</span>,\r\n  <span class=\"hljs-attr\">nonce</span>: <span class=\"hljs-string\">\"8GLRMV\"</span>,\r\n  <span class=\"hljs-attr\">pubkey</span>:\r\n    <span class=\"hljs-string\">\"EB2A38568661887FA180BDDB5CABD5F21C7BFD59C090CB2D245A87AC253062882729293E5506350508E7F9AA3BB77F4333231490F915F6D63C55FE2F08A49B353F444AD3993CACC02DB784ABBB8E42A9B1BBFFFB38BE18D78E87A0E41B9B8F73A928EE0CCEE1F6739884B9777E4FE9E88A1BBE495927AC4A799B3181D6442443\"</span>,\r\n  <span class=\"hljs-attr\">rsakv</span>: <span class=\"hljs-string\">\"1330428213\"</span>,\r\n  <span class=\"hljs-attr\">is_openlock</span>: <span class=\"hljs-number\">0</span>,\r\n  <span class=\"hljs-attr\">showpin</span>: <span class=\"hljs-number\">1</span>,\r\n  <span class=\"hljs-attr\">exectime</span>: <span class=\"hljs-number\">23</span>,\r\n})</code></pre>\n<p>使用以下代码将其中的参数转换为一个 python 的 dict:</p>\n<pre><code class=\"hljs language-python\">    res = response.text.replace(<span class=\"hljs-string\">\"sinaSSOController.preloginCallBack\"</span>, <span class=\"hljs-string\">''</span>)\r\n    server_data = <span class=\"hljs-built_in\">eval</span>(res)</code></pre>\n<p>使用得到的<code>servertime</code>、<code>nonce</code>和<code>pubkey</code>参数得出 RSA 加密后的密码：</p>\n<pre><code class=\"hljs language-python\">    rsaPublickey = <span class=\"hljs-built_in\">int</span>(server_data[<span class=\"hljs-string\">'pubkey'</span>], <span class=\"hljs-number\">16</span>)\r\n    key = rsa.PublicKey(rsaPublickey, <span class=\"hljs-number\">65537</span>)\r\n    message = <span class=\"hljs-built_in\">str</span>(server_data[<span class=\"hljs-string\">'servertime'</span>]) + <span class=\"hljs-string\">'\\t'</span> + <span class=\"hljs-built_in\">str</span>(server_data[<span class=\"hljs-string\">'nonce'</span>]) + <span class=\"hljs-string\">'\\n'</span> + <span class=\"hljs-built_in\">str</span>(self.password)\r\n    message = message.encode(<span class=\"hljs-string\">\"utf-8\"</span>)\r\n    passwd = rsa.encrypt(message, key)\r\n    passwd = binascii.b2a_hex(passwd)</code></pre>\n<p>然后就可以发送登录请求了：</p>\n<pre><code class=\"hljs language-python\">login_url = <span class=\"hljs-string\">'https://login.sina.com.cn/sso/login.php?client=ssologin.js(v1.4.18)&#x26;_=%s&#x26;openapilogin=qrcode'</span> % <span class=\"hljs-built_in\">str</span>(<span class=\"hljs-built_in\">int</span>(time.time()))\r\nscrapy.FormRequest(\r\n    login_url,\r\n    meta={<span class=\"hljs-string\">'cookiejar'</span>: response.meta[<span class=\"hljs-string\">'cookiejar'</span>]},\r\n    headers=self.headers,\r\n    formdata={\r\n        <span class=\"hljs-string\">'entry'</span>:<span class=\"hljs-string\">'openapi'</span>,\r\n        <span class=\"hljs-string\">'gateway'</span>:<span class=\"hljs-string\">'1'</span>,\r\n        <span class=\"hljs-string\">'from'</span>:<span class=\"hljs-string\">''</span>,\r\n        <span class=\"hljs-string\">'savestate'</span>:<span class=\"hljs-string\">'0'</span>,\r\n        <span class=\"hljs-string\">'useticket'</span>:<span class=\"hljs-string\">'1'</span>,\r\n        <span class=\"hljs-string\">'pagerefer'</span>:<span class=\"hljs-string\">'http://music.163.com/'</span>,\r\n        <span class=\"hljs-string\">'ct'</span>:<span class=\"hljs-string\">'1800'</span>,\r\n        <span class=\"hljs-string\">'s'</span>:<span class=\"hljs-string\">'1'</span>,\r\n        <span class=\"hljs-string\">'vsnf'</span>:<span class=\"hljs-string\">'1'</span>,\r\n        <span class=\"hljs-string\">'vsnval'</span>:<span class=\"hljs-string\">''</span>,\r\n        <span class=\"hljs-string\">'door'</span>:<span class=\"hljs-string\">''</span>,\r\n        <span class=\"hljs-string\">'appkey'</span>:<span class=\"hljs-string\">'u6BYq'</span>,\r\n        <span class=\"hljs-string\">'su'</span>:self.get_su(),\r\n        <span class=\"hljs-string\">'service'</span>:<span class=\"hljs-string\">'miniblog'</span>,\r\n        <span class=\"hljs-string\">'servertime'</span>:<span class=\"hljs-built_in\">str</span>(server_data[<span class=\"hljs-string\">'servertime'</span>]),\r\n        <span class=\"hljs-string\">'nonce'</span>:<span class=\"hljs-built_in\">str</span>(server_data[<span class=\"hljs-string\">'nonce'</span>]),\r\n        <span class=\"hljs-string\">'pwencode'</span>:<span class=\"hljs-string\">'rsa2'</span>,\r\n        <span class=\"hljs-string\">'rsakv'</span>:<span class=\"hljs-built_in\">str</span>(server_data[<span class=\"hljs-string\">'rsakv'</span>]),\r\n        <span class=\"hljs-string\">'sp'</span>:passwd,\r\n        <span class=\"hljs-string\">'sr'</span>:<span class=\"hljs-string\">'1366*768'</span>,\r\n        <span class=\"hljs-string\">'encoding'</span>:<span class=\"hljs-string\">'UTF-8'</span>,\r\n        <span class=\"hljs-string\">'cdult'</span>:<span class=\"hljs-string\">'2'</span>,\r\n        <span class=\"hljs-string\">'domain'</span>:<span class=\"hljs-string\">'weibo.com'</span>,\r\n        <span class=\"hljs-string\">'prelt'</span>:<span class=\"hljs-string\">'55'</span>,\r\n        <span class=\"hljs-string\">'returntype'</span>:<span class=\"hljs-string\">'TEXT'</span>\r\n    },\r\n    callback=self.authorize_request,\r\n)</code></pre>\n<p>然后是对网易云音乐的授权，请求表单需要提供登录成功返回的<code>ticket</code>值：</p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title\">authorize_request</span>(<span class=\"hljs-params\">self,response</span>):</span>\r\n    response_json = json.loads(response.text)\r\n    authorize_url = <span class=\"hljs-string\">'https://api.weibo.com/oauth2/authorize'</span>\r\n    <span class=\"hljs-keyword\">return</span> scrapy.FormRequest(authorize_url,\r\n        headers=self.headers,\r\n        meta={<span class=\"hljs-string\">'cookiejar'</span>: response.meta[<span class=\"hljs-string\">'cookiejar'</span>]},\r\n        formdata={\r\n            <span class=\"hljs-string\">'action'</span>:<span class=\"hljs-string\">'login'</span>,\r\n            <span class=\"hljs-string\">'display'</span>:<span class=\"hljs-string\">'default'</span>,\r\n            <span class=\"hljs-string\">'withOfficalFlag'</span>:<span class=\"hljs-string\">'0'</span>,\r\n            <span class=\"hljs-string\">'quick_auth'</span>:<span class=\"hljs-string\">'false'</span>,\r\n            <span class=\"hljs-string\">'withOfficalAccount'</span>:<span class=\"hljs-string\">''</span>,\r\n            <span class=\"hljs-string\">'scope'</span>:<span class=\"hljs-string\">''</span>,\r\n            <span class=\"hljs-string\">'ticket'</span>:response_json[<span class=\"hljs-string\">'ticket'</span>],\r\n            <span class=\"hljs-string\">'isLoginSina'</span>:<span class=\"hljs-string\">''</span>,\r\n            <span class=\"hljs-string\">'response_type'</span>:<span class=\"hljs-string\">'code'</span>,\r\n            <span class=\"hljs-string\">'regCallback'</span>:<span class=\"hljs-string\">'https://api.weibo.com/oauth2/authorize?client_id=301575942&#x26;response_type=code&#x26;redirect_uri=http://music.163.com/back/weibo&#x26;forcelogin=true&#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog'</span>,\r\n            <span class=\"hljs-string\">'redirect_uri'</span>:<span class=\"hljs-string\">'http://music.163.com/back/weibo'</span>,\r\n            <span class=\"hljs-string\">'client_id'</span>:<span class=\"hljs-string\">'301575942'</span>,\r\n            <span class=\"hljs-string\">'appkey62'</span>:<span class=\"hljs-string\">'u6BYq'</span>,\r\n            <span class=\"hljs-string\">'state'</span>:<span class=\"hljs-string\">''</span>,\r\n            <span class=\"hljs-string\">'verifyToken'</span>:<span class=\"hljs-string\">'null'</span>,\r\n            <span class=\"hljs-string\">'from'</span>:<span class=\"hljs-string\">''</span>,\r\n            <span class=\"hljs-string\">'switchLogin'</span>:<span class=\"hljs-string\">'0'</span>,\r\n            <span class=\"hljs-string\">'userId'</span>:<span class=\"hljs-string\">''</span>,\r\n            <span class=\"hljs-string\">'passwd'</span>:<span class=\"hljs-string\">''</span>\r\n        },\r\n        callback=do_something)</code></pre>\n<p>授权成功后会跳转到<code>http://music.163.com/back/sns</code>,返回了网易云音乐用户的 uid 和一些信息，大功告成~</p>"},"prev":{"slug":"Laravel-passport-for-api-auth","title":"使用laravel/passport的客户端api认证","date":1477604930000},"next":{"slug":"winter-vacation-daily","title":"寒假日常","date":1519837064000}},"__N_SSG":true}