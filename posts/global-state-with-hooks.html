<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/favicon.png"/><meta name="theme-color" content="#000000"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><meta name="image" content="/favicon.png"/><title>Global state with hooks -Arthas.me</title><meta property="og:url" content="https://arthas.me/posts/global-state-with-hooks"/><meta property="og:type" content="article"/><meta property="og:title" content="Global state with hooks"/><meta property="og:image" content="/favicon.png"/><meta name="twitter:title" content="Global state with hooks"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="/favicon.png"/><meta name="twitter:creator" content="@deadalusmask"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/dd23f042793788fe269b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dd23f042793788fe269b.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.2113c6061a2f456066a1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.f771efd637e54964f7dc.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-ff7d19fcc1eef3597074.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" as="script"/></head><body><div id="__next"><div class="page"><h3><a href="/">Arthas.me</a> / <a href="/posts">Posts</a> /</h3><h1>Global state with hooks</h1><span>2019.7.12</span><div class="md-content"><h2>backgrounds</h2>
<p>Problems when manage global state with hooks and context api:</p>
<p><a href="https://github.com/facebook/react/issues/15156#issuecomment-474590693">Preventing rerenders with React.memo and useContext hook.</a></p>
<h2>original idea</h2>
<p><a href="https://medium.com/javascript-in-plain-english/state-management-with-react-hooks-no-redux-or-context-api-8b3035ceecf8">State Management with React Hooks — No Redux or Context API</a></p>
<h2>clear implantation with TS</h2>
<p>useGlobalState.ts</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { useState, useEffect, Dispatch, SetStateAction } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">type</span> id&#x3C;T> = <span class="hljs-function">(<span class="hljs-params">a: T</span>) =></span> T

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useGlobalState</span>&#x3C;<span class="hljs-title">T</span>>(<span class="hljs-params">initialState: T</span>) </span>{
  <span class="hljs-keyword">let</span> state = initialState
  <span class="hljs-keyword">let</span> listeners: <span class="hljs-built_in">Array</span>&#x3C;Dispatch&#x3C;SetStateAction&#x3C;T>>> = []

  <span class="hljs-keyword">const</span> setState = <span class="hljs-function">(<span class="hljs-params">newState: T | id&#x3C;T></span>) =></span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newState === <span class="hljs-string">'function'</span>) {
      state = (newState <span class="hljs-keyword">as</span> id&#x3C;T>)(state)
    } <span class="hljs-keyword">else</span> {
      state = newState <span class="hljs-keyword">as</span> T
    }
    listeners.forEach(<span class="hljs-function"><span class="hljs-params">listener</span> =></span> {
      listener(state)
    })
  }

  <span class="hljs-keyword">const</span> useCustom: <span class="hljs-function">() =></span> [T, <span class="hljs-function">(<span class="hljs-params">state: T | id&#x3C;T></span>) =></span> <span class="hljs-built_in">void</span>] = <span class="hljs-function">() =></span> {
    <span class="hljs-keyword">const</span> newListener = useState(initialState)[<span class="hljs-number">1</span>]
    useEffect(<span class="hljs-function">() =></span> {
      listeners.push(newListener)
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =></span> {
        listeners = listeners.filter(<span class="hljs-function"><span class="hljs-params">listener</span> =></span> listener !== newListener)
      }
      <span class="hljs-comment">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
    }, [])
    <span class="hljs-keyword">return</span> [state, setState]
  }
  <span class="hljs-keyword">return</span> useCustom
}</code></pre>
<h2>usage</h2>
<p>store.ts</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> useGlobalState <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalState'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useGlobalCount = useGlobalState(<span class="hljs-number">0</span>)</code></pre>
<p>A.tsx</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { useGlobalCount } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store'</span>
<span class="hljs-keyword">const</span> A: React.FC = <span class="hljs-function">() =></span> {
  <span class="hljs-keyword">const</span> [count, setCount] = useGlobalCount()
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">span</span>></span>A {count}<span class="hljs-tag">&#x3C;/<span class="hljs-name">span</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =></span> setCount(count + 1)}> + <span class="hljs-tag">&#x3C;/<span class="hljs-name">button</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> A</code></pre>
<p>B.tsx</p>
<pre><code class="hljs language-jsx"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { useGlobalCount } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store'</span>
<span class="hljs-keyword">const</span> B: React.FC = <span class="hljs-function">() =></span> {
  <span class="hljs-keyword">const</span> [count, setCount] = useGlobalCount()
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">div</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">span</span>></span>B {count}<span class="hljs-tag">&#x3C;/<span class="hljs-name">span</span>></span>
      <span class="hljs-tag">&#x3C;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =></span> setCount(count - 1)}> - <span class="hljs-tag">&#x3C;/<span class="hljs-name">button</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> B</code></pre>
<p>And you can also pass a object to <code>useGlobalState</code> and wrap it with mutations and actions in <code>store.ts</code>.</p></div><hr class="hr"/><div style="display:flex;justify-content:space-between"><a style="margin-right:24px" href="/posts/ray-casting-selecting">在WebGL中使用射线选择模型</a><a href="/posts/cg">我理解的计算机图形学</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Global state with hooks","date":1562871240000,"slug":"global-state-with-hooks","content":"\u003ch2\u003ebackgrounds\u003c/h2\u003e\n\u003cp\u003eProblems when manage global state with hooks and context api:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/facebook/react/issues/15156#issuecomment-474590693\"\u003ePreventing rerenders with React.memo and useContext hook.\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eoriginal idea\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://medium.com/javascript-in-plain-english/state-management-with-react-hooks-no-redux-or-context-api-8b3035ceecf8\"\u003eState Management with React Hooks — No Redux or Context API\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eclear implantation with TS\u003c/h2\u003e\n\u003cp\u003euseGlobalState.ts\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { useState, useEffect, Dispatch, SetStateAction } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'react'\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e id\u0026#x3C;T\u003e = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ea: T\u003c/span\u003e) =\u003e\u003c/span\u003e T\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003euseGlobalState\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title\"\u003eT\u003c/span\u003e\u003e(\u003cspan class=\"hljs-params\"\u003einitialState: T\u003c/span\u003e) \u003c/span\u003e{\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e state = initialState\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e listeners: \u003cspan class=\"hljs-built_in\"\u003eArray\u003c/span\u003e\u0026#x3C;Dispatch\u0026#x3C;SetStateAction\u0026#x3C;T\u003e\u003e\u003e = []\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e setState = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003enewState: T | id\u0026#x3C;T\u003e\u003c/span\u003e) =\u003e\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newState === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n      state = (newState \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e id\u0026#x3C;T\u003e)(state)\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      state = newState \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e T\r\n    }\r\n    listeners.forEach(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003elistener\u003c/span\u003e =\u003e\u003c/span\u003e {\r\n      listener(state)\r\n    })\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e useCustom: \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e [T, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003estate: T | id\u0026#x3C;T\u003e\u003c/span\u003e) =\u003e\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003evoid\u003c/span\u003e] = \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newListener = useState(initialState)[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e]\r\n    useEffect(\u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\r\n      listeners.push(newListener)\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\r\n        listeners = listeners.filter(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003elistener\u003c/span\u003e =\u003e\u003c/span\u003e listener !== newListener)\r\n      }\r\n      \u003cspan class=\"hljs-comment\"\u003e// eslint-disable-next-line react-hooks/exhaustive-deps\u003c/span\u003e\r\n    }, [])\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [state, setState]\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e useCustom\r\n}\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eusage\u003c/h2\u003e\n\u003cp\u003estore.ts\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e useGlobalState \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'./useGlobalState'\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e useGlobalCount = useGlobalState(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eA.tsx\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-jsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e React \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'react'\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { useGlobalCount } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'../store'\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e A: React.FC = \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [count, setCount] = useGlobalCount()\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\r\n    \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u003e\u003c/span\u003e\r\n      \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003espan\u003c/span\u003e\u003e\u003c/span\u003eA {count}\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003espan\u003c/span\u003e\u003e\u003c/span\u003e\r\n      \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eonClick\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{()\u003c/span\u003e =\u003e\u003c/span\u003e setCount(count + 1)}\u003e + \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e\u003e\u003c/span\u003e\r\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u003e\u003c/span\u003e\u003c/span\u003e\r\n  )\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e A\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eB.tsx\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-jsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e React \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'react'\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { useGlobalCount } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'../store'\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e B: React.FC = \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [count, setCount] = useGlobalCount()\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\r\n    \u003cspan class=\"xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u003e\u003c/span\u003e\r\n      \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003espan\u003c/span\u003e\u003e\u003c/span\u003eB {count}\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003espan\u003c/span\u003e\u003e\u003c/span\u003e\r\n      \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eonClick\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{()\u003c/span\u003e =\u003e\u003c/span\u003e setCount(count - 1)}\u003e - \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e\u003e\u003c/span\u003e\r\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u003e\u003c/span\u003e\u003c/span\u003e\r\n  )\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e B\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd you can also pass a object to \u003ccode\u003euseGlobalState\u003c/code\u003e and wrap it with mutations and actions in \u003ccode\u003estore.ts\u003c/code\u003e.\u003c/p\u003e"},"prev":{"slug":"ray-casting-selecting","title":"在WebGL中使用射线选择模型","date":1534877523000},"next":{"slug":"cg","title":"我理解的计算机图形学","date":1576780980000}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"global-state-with-hooks"},"buildId":"s2lQGLd0xJvTQahu6yiKS","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-a98cee78eb8282e29fb6.js"></script><script src="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.2113c6061a2f456066a1.js" async=""></script><script src="/_next/static/chunks/commons.f771efd637e54964f7dc.js" async=""></script><script src="/_next/static/chunks/pages/_app-ff7d19fcc1eef3597074.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" async=""></script><script src="/_next/static/s2lQGLd0xJvTQahu6yiKS/_buildManifest.js" async=""></script><script src="/_next/static/s2lQGLd0xJvTQahu6yiKS/_ssgManifest.js" async=""></script></body></html>