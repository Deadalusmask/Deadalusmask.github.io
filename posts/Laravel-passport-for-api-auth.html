<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/favicon.png"/><meta name="theme-color" content="#000000"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><meta name="image" content="/favicon.png"/><title>使用laravel/passport的客户端api认证 -Arthas.me</title><meta property="og:url" content="https://arthas.me/posts/Laravel-passport-for-api-auth"/><meta property="og:type" content="article"/><meta property="og:title" content="使用laravel/passport的客户端api认证"/><meta property="og:image" content="/favicon.png"/><meta name="twitter:title" content="使用laravel/passport的客户端api认证"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="/favicon.png"/><meta name="twitter:creator" content="@deadalusmask"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/dd23f042793788fe269b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dd23f042793788fe269b.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.2113c6061a2f456066a1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.f771efd637e54964f7dc.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-ff7d19fcc1eef3597074.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" as="script"/></head><body><div id="__next"><div class="page"><h3><a href="/">Arthas.me</a> / <a href="/posts">Posts</a> /</h3><h1>使用laravel/passport的客户端api认证</h1><span>2016.10.28</span><div class="md-content"><h3>根据官方文档安装 passport</h3>
<p>在执行<code>passport:install</code>时 passport 已经创建了 id 为 2 的密码发放客户端;</p>
<h3>用 js 消费 api</h3>
<p>用 js 请求<code>/oauth/token</code>来获取<code>access_token</code>和<code>refresh_token</code>;</p>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-title">login</span>(<span class="hljs-params"></span>)</span> {
  <span class="hljs-keyword">const</span> data = {
    <span class="hljs-attr">grant_type</span>: <span class="hljs-string">'password'</span>,
    <span class="hljs-attr">client_id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">client_secret</span>: 数据库中的secret值,
    <span class="hljs-attr">username</span>: $(<span class="hljs-string">"#username"</span>).val(),
    <span class="hljs-attr">password</span>: $(<span class="hljs-string">"#password"</span>).val(),
    <span class="hljs-attr">scope</span>: <span class="hljs-string">'*'</span>
  }

  <span class="hljs-built_in">this</span>.$http.post(<span class="hljs-string">'/oauth/token'</span>, <span class="hljs-built_in">JSON</span>.stringify(data))
    .then(<span class="hljs-function"><span class="hljs-params">response</span> =></span>{
      <span class="hljs-built_in">console</span>.log(response.data.access_token)
      Cookies.set(<span class="hljs-string">'api_token'</span>,response.data.access_token)
    })
    .catch(<span class="hljs-built_in">console</span>.error)
},</code></pre>
<p>将获取到的 api_token 添加到 header 的<code>Authorization</code>中，</p>
<p>设置其值为<code>Bearer TOKEN</code>， 其中 TOKEN 是<code>api_token</code>的值，</p>
<p>其中 Bearer 表示令牌类型。</p>
<h3>路由</h3>
<p>在<code>routes/api.php</code>中添加</p>
<pre><code class="hljs language-php">Route::get(<span class="hljs-string">'/test'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'success'</span>;
})->middleware(<span class="hljs-string">'auth:api'</span>);</code></pre>
<h3>JS</h3>
<pre><code class="hljs language-js"><span class="hljs-function"><span class="hljs-title">test</span>(<span class="hljs-params"></span>)</span> {
  <span class="hljs-built_in">this</span>.$http.get(<span class="hljs-string">'/api/test'</span>,{
    <span class="hljs-attr">headers</span>:{
      <span class="hljs-string">'Authorization'</span> : <span class="hljs-string">'Bearer '</span>+ Cookies.get(<span class="hljs-string">'api_token'</span>),
    }
  }).then(<span class="hljs-function"><span class="hljs-params">response</span> =></span>{
    <span class="hljs-built_in">this</span>.msg = response.data
  }, <span class="hljs-function"><span class="hljs-params">response</span> =></span> {
    <span class="hljs-built_in">this</span>.msg = <span class="hljs-string">'failed'</span>
  })
},</code></pre></div><hr class="hr"/><div style="display:flex;justify-content:space-between"><a style="margin-right:24px" href="/posts/Archlinux-note-2">Archlinux笔记(三)</a><a href="/posts/weibo-third-party-login">新浪微博登录第三方应用</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"使用laravel/passport的客户端api认证","date":1477604930000,"slug":"Laravel-passport-for-api-auth","content":"\u003ch3\u003e根据官方文档安装 passport\u003c/h3\u003e\n\u003cp\u003e在执行\u003ccode\u003epassport:install\u003c/code\u003e时 passport 已经创建了 id 为 2 的密码发放客户端;\u003c/p\u003e\n\u003ch3\u003e用 js 消费 api\u003c/h3\u003e\n\u003cp\u003e用 js 请求\u003ccode\u003e/oauth/token\u003c/code\u003e来获取\u003ccode\u003eaccess_token\u003c/code\u003e和\u003ccode\u003erefresh_token\u003c/code\u003e;\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003elogin\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e data = {\r\n    \u003cspan class=\"hljs-attr\"\u003egrant_type\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'password'\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003eclient_id\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003eclient_secret\u003c/span\u003e: 数据库中的secret值,\r\n    \u003cspan class=\"hljs-attr\"\u003eusername\u003c/span\u003e: $(\u003cspan class=\"hljs-string\"\u003e\"#username\"\u003c/span\u003e).val(),\r\n    \u003cspan class=\"hljs-attr\"\u003epassword\u003c/span\u003e: $(\u003cspan class=\"hljs-string\"\u003e\"#password\"\u003c/span\u003e).val(),\r\n    \u003cspan class=\"hljs-attr\"\u003escope\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'*'\u003c/span\u003e\r\n  }\r\n\r\n  \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.$http.post(\u003cspan class=\"hljs-string\"\u003e'/oauth/token'\u003c/span\u003e, \u003cspan class=\"hljs-built_in\"\u003eJSON\u003c/span\u003e.stringify(data))\r\n    .then(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003eresponse\u003c/span\u003e =\u003e\u003c/span\u003e{\r\n      \u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.log(response.data.access_token)\r\n      Cookies.set(\u003cspan class=\"hljs-string\"\u003e'api_token'\u003c/span\u003e,response.data.access_token)\r\n    })\r\n    .catch(\u003cspan class=\"hljs-built_in\"\u003econsole\u003c/span\u003e.error)\r\n},\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e将获取到的 api_token 添加到 header 的\u003ccode\u003eAuthorization\u003c/code\u003e中，\u003c/p\u003e\n\u003cp\u003e设置其值为\u003ccode\u003eBearer TOKEN\u003c/code\u003e， 其中 TOKEN 是\u003ccode\u003eapi_token\u003c/code\u003e的值，\u003c/p\u003e\n\u003cp\u003e其中 Bearer 表示令牌类型。\u003c/p\u003e\n\u003ch3\u003e路由\u003c/h3\u003e\n\u003cp\u003e在\u003ccode\u003eroutes/api.php\u003c/code\u003e中添加\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-php\"\u003eRoute::get(\u003cspan class=\"hljs-string\"\u003e'/test'\u003c/span\u003e,\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e{\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'success'\u003c/span\u003e;\r\n})-\u003emiddleware(\u003cspan class=\"hljs-string\"\u003e'auth:api'\u003c/span\u003e);\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eJS\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003etest\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e)\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.$http.get(\u003cspan class=\"hljs-string\"\u003e'/api/test'\u003c/span\u003e,{\r\n    \u003cspan class=\"hljs-attr\"\u003eheaders\u003c/span\u003e:{\r\n      \u003cspan class=\"hljs-string\"\u003e'Authorization'\u003c/span\u003e : \u003cspan class=\"hljs-string\"\u003e'Bearer '\u003c/span\u003e+ Cookies.get(\u003cspan class=\"hljs-string\"\u003e'api_token'\u003c/span\u003e),\r\n    }\r\n  }).then(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003eresponse\u003c/span\u003e =\u003e\u003c/span\u003e{\r\n    \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.msg = response.data\r\n  }, \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003eresponse\u003c/span\u003e =\u003e\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-built_in\"\u003ethis\u003c/span\u003e.msg = \u003cspan class=\"hljs-string\"\u003e'failed'\u003c/span\u003e\r\n  })\r\n},\u003c/code\u003e\u003c/pre\u003e"},"prev":{"slug":"Archlinux-note-2","title":"Archlinux笔记(三)","date":1461147759000},"next":{"slug":"weibo-third-party-login","title":"新浪微博登录第三方应用","date":1509204819000}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"Laravel-passport-for-api-auth"},"buildId":"s2lQGLd0xJvTQahu6yiKS","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-a98cee78eb8282e29fb6.js"></script><script src="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.2113c6061a2f456066a1.js" async=""></script><script src="/_next/static/chunks/commons.f771efd637e54964f7dc.js" async=""></script><script src="/_next/static/chunks/pages/_app-ff7d19fcc1eef3597074.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" async=""></script><script src="/_next/static/s2lQGLd0xJvTQahu6yiKS/_buildManifest.js" async=""></script><script src="/_next/static/s2lQGLd0xJvTQahu6yiKS/_ssgManifest.js" async=""></script></body></html>