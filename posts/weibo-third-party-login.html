<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/favicon.png"/><meta name="theme-color" content="#000000"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><meta name="image" content="/favicon.png"/><title>新浪微博登录第三方应用 -Arthas.me</title><meta property="og:url" content="https://arthas.me/posts/weibo-third-party-login"/><meta property="og:type" content="article"/><meta property="og:title" content="新浪微博登录第三方应用"/><meta property="og:image" content="/favicon.png"/><meta name="twitter:title" content="新浪微博登录第三方应用"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="/favicon.png"/><meta name="twitter:creator" content="@deadalusmask"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/dd23f042793788fe269b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dd23f042793788fe269b.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.2113c6061a2f456066a1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.f771efd637e54964f7dc.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-ff7d19fcc1eef3597074.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" as="script"/></head><body><div id="__next"><div class="page"><h3><a href="/">Arthas.me</a> / <a href="/posts">Posts</a> /</h3><h1>新浪微博登录第三方应用</h1><span>2017.10.28</span><div class="md-content"><p>通过观察网易云音乐使用微博登录时跳转的页面<a href="https://api.weibo.com/oauth2/authorize?client_id=301575942&#x26;response_type=code&#x26;redirect_uri=http://music.163.com/back/weibo&#x26;forcelogin=true&#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog">应用授权-网易云音乐</a>，在微博账号的输入栏被填写并失去焦点后，会发送一个到 prelogin.php 的请求，请求的 url 为</p>
<p><code>https://login.sina.com.cn/sso/prelogin.php?entry=openapi&#x26;callback=sinaSSOController.preloginCallBack&#x26;su=MTEx&#x26;rsakt=mod&#x26;checkpin=1&#x26;client=ssologin.js(v1.4.18)&#x26;_=1509178064363</code></p>
<p>其中请求参数<code>su</code>为 base64 编码的账号字符串，<code>_</code>为当前时间，这里用<code>int(time.time()*1000)</code>生成。</p>
<pre><code class="hljs language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start_requests</span>(<span class="hljs-params">self</span>):</span>
    username_quote = urllib.parse.quote_plus(self.username)
    username_base64 = base64.b64encode(username_quote.encode(<span class="hljs-string">"utf-8"</span>))
    su =  username_base64.decode(<span class="hljs-string">"utf-8"</span>)
    prelogin_url = <span class="hljs-string">'https://login.sina.com.cn/sso/prelogin.php?entry=openapi&#x26;callback=sinaSSOController.preloginCallBack&#x26;su=%s&#x26;rsakt=mod&#x26;checkpin=1&#x26;client=ssologin.js(v1.4.18)&#x26;_=%s'</span> % (su,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(time.time())))
    <span class="hljs-keyword">return</span> [scrapy.Request(prelogin_url,headers=self.headers,meta={<span class="hljs-string">"cookiejar"</span>: <span class="hljs-number">1</span>},callback=self.login_request)]</code></pre>
<p>请求的返回结果为：</p>
<pre><code class="hljs language-js">sinaSSOController.preloginCallBack({
  <span class="hljs-attr">retcode</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">servertime</span>: <span class="hljs-number">1509178513</span>,
  <span class="hljs-attr">pcid</span>: <span class="hljs-string">"yf-db7f8e82296bf55717be22d63e61976356da"</span>,
  <span class="hljs-attr">nonce</span>: <span class="hljs-string">"8GLRMV"</span>,
  <span class="hljs-attr">pubkey</span>:
    <span class="hljs-string">"EB2A38568661887FA180BDDB5CABD5F21C7BFD59C090CB2D245A87AC253062882729293E5506350508E7F9AA3BB77F4333231490F915F6D63C55FE2F08A49B353F444AD3993CACC02DB784ABBB8E42A9B1BBFFFB38BE18D78E87A0E41B9B8F73A928EE0CCEE1F6739884B9777E4FE9E88A1BBE495927AC4A799B3181D6442443"</span>,
  <span class="hljs-attr">rsakv</span>: <span class="hljs-string">"1330428213"</span>,
  <span class="hljs-attr">is_openlock</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">showpin</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">exectime</span>: <span class="hljs-number">23</span>,
})</code></pre>
<p>使用以下代码将其中的参数转换为一个 python 的 dict:</p>
<pre><code class="hljs language-python">    res = response.text.replace(<span class="hljs-string">"sinaSSOController.preloginCallBack"</span>, <span class="hljs-string">''</span>)
    server_data = <span class="hljs-built_in">eval</span>(res)</code></pre>
<p>使用得到的<code>servertime</code>、<code>nonce</code>和<code>pubkey</code>参数得出 RSA 加密后的密码：</p>
<pre><code class="hljs language-python">    rsaPublickey = <span class="hljs-built_in">int</span>(server_data[<span class="hljs-string">'pubkey'</span>], <span class="hljs-number">16</span>)
    key = rsa.PublicKey(rsaPublickey, <span class="hljs-number">65537</span>)
    message = <span class="hljs-built_in">str</span>(server_data[<span class="hljs-string">'servertime'</span>]) + <span class="hljs-string">'\t'</span> + <span class="hljs-built_in">str</span>(server_data[<span class="hljs-string">'nonce'</span>]) + <span class="hljs-string">'\n'</span> + <span class="hljs-built_in">str</span>(self.password)
    message = message.encode(<span class="hljs-string">"utf-8"</span>)
    passwd = rsa.encrypt(message, key)
    passwd = binascii.b2a_hex(passwd)</code></pre>
<p>然后就可以发送登录请求了：</p>
<pre><code class="hljs language-python">login_url = <span class="hljs-string">'https://login.sina.com.cn/sso/login.php?client=ssologin.js(v1.4.18)&#x26;_=%s&#x26;openapilogin=qrcode'</span> % <span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(time.time()))
scrapy.FormRequest(
    login_url,
    meta={<span class="hljs-string">'cookiejar'</span>: response.meta[<span class="hljs-string">'cookiejar'</span>]},
    headers=self.headers,
    formdata={
        <span class="hljs-string">'entry'</span>:<span class="hljs-string">'openapi'</span>,
        <span class="hljs-string">'gateway'</span>:<span class="hljs-string">'1'</span>,
        <span class="hljs-string">'from'</span>:<span class="hljs-string">''</span>,
        <span class="hljs-string">'savestate'</span>:<span class="hljs-string">'0'</span>,
        <span class="hljs-string">'useticket'</span>:<span class="hljs-string">'1'</span>,
        <span class="hljs-string">'pagerefer'</span>:<span class="hljs-string">'http://music.163.com/'</span>,
        <span class="hljs-string">'ct'</span>:<span class="hljs-string">'1800'</span>,
        <span class="hljs-string">'s'</span>:<span class="hljs-string">'1'</span>,
        <span class="hljs-string">'vsnf'</span>:<span class="hljs-string">'1'</span>,
        <span class="hljs-string">'vsnval'</span>:<span class="hljs-string">''</span>,
        <span class="hljs-string">'door'</span>:<span class="hljs-string">''</span>,
        <span class="hljs-string">'appkey'</span>:<span class="hljs-string">'u6BYq'</span>,
        <span class="hljs-string">'su'</span>:self.get_su(),
        <span class="hljs-string">'service'</span>:<span class="hljs-string">'miniblog'</span>,
        <span class="hljs-string">'servertime'</span>:<span class="hljs-built_in">str</span>(server_data[<span class="hljs-string">'servertime'</span>]),
        <span class="hljs-string">'nonce'</span>:<span class="hljs-built_in">str</span>(server_data[<span class="hljs-string">'nonce'</span>]),
        <span class="hljs-string">'pwencode'</span>:<span class="hljs-string">'rsa2'</span>,
        <span class="hljs-string">'rsakv'</span>:<span class="hljs-built_in">str</span>(server_data[<span class="hljs-string">'rsakv'</span>]),
        <span class="hljs-string">'sp'</span>:passwd,
        <span class="hljs-string">'sr'</span>:<span class="hljs-string">'1366*768'</span>,
        <span class="hljs-string">'encoding'</span>:<span class="hljs-string">'UTF-8'</span>,
        <span class="hljs-string">'cdult'</span>:<span class="hljs-string">'2'</span>,
        <span class="hljs-string">'domain'</span>:<span class="hljs-string">'weibo.com'</span>,
        <span class="hljs-string">'prelt'</span>:<span class="hljs-string">'55'</span>,
        <span class="hljs-string">'returntype'</span>:<span class="hljs-string">'TEXT'</span>
    },
    callback=self.authorize_request,
)</code></pre>
<p>然后是对网易云音乐的授权，请求表单需要提供登录成功返回的<code>ticket</code>值：</p>
<pre><code class="hljs language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authorize_request</span>(<span class="hljs-params">self,response</span>):</span>
    response_json = json.loads(response.text)
    authorize_url = <span class="hljs-string">'https://api.weibo.com/oauth2/authorize'</span>
    <span class="hljs-keyword">return</span> scrapy.FormRequest(authorize_url,
        headers=self.headers,
        meta={<span class="hljs-string">'cookiejar'</span>: response.meta[<span class="hljs-string">'cookiejar'</span>]},
        formdata={
            <span class="hljs-string">'action'</span>:<span class="hljs-string">'login'</span>,
            <span class="hljs-string">'display'</span>:<span class="hljs-string">'default'</span>,
            <span class="hljs-string">'withOfficalFlag'</span>:<span class="hljs-string">'0'</span>,
            <span class="hljs-string">'quick_auth'</span>:<span class="hljs-string">'false'</span>,
            <span class="hljs-string">'withOfficalAccount'</span>:<span class="hljs-string">''</span>,
            <span class="hljs-string">'scope'</span>:<span class="hljs-string">''</span>,
            <span class="hljs-string">'ticket'</span>:response_json[<span class="hljs-string">'ticket'</span>],
            <span class="hljs-string">'isLoginSina'</span>:<span class="hljs-string">''</span>,
            <span class="hljs-string">'response_type'</span>:<span class="hljs-string">'code'</span>,
            <span class="hljs-string">'regCallback'</span>:<span class="hljs-string">'https://api.weibo.com/oauth2/authorize?client_id=301575942&#x26;response_type=code&#x26;redirect_uri=http://music.163.com/back/weibo&#x26;forcelogin=true&#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog'</span>,
            <span class="hljs-string">'redirect_uri'</span>:<span class="hljs-string">'http://music.163.com/back/weibo'</span>,
            <span class="hljs-string">'client_id'</span>:<span class="hljs-string">'301575942'</span>,
            <span class="hljs-string">'appkey62'</span>:<span class="hljs-string">'u6BYq'</span>,
            <span class="hljs-string">'state'</span>:<span class="hljs-string">''</span>,
            <span class="hljs-string">'verifyToken'</span>:<span class="hljs-string">'null'</span>,
            <span class="hljs-string">'from'</span>:<span class="hljs-string">''</span>,
            <span class="hljs-string">'switchLogin'</span>:<span class="hljs-string">'0'</span>,
            <span class="hljs-string">'userId'</span>:<span class="hljs-string">''</span>,
            <span class="hljs-string">'passwd'</span>:<span class="hljs-string">''</span>
        },
        callback=do_something)</code></pre>
<p>授权成功后会跳转到<code>http://music.163.com/back/sns</code>,返回了网易云音乐用户的 uid 和一些信息，大功告成~</p></div><hr class="hr"/><div style="display:flex;justify-content:space-between"><a style="margin-right:24px" href="/posts/Laravel-passport-for-api-auth">使用laravel/passport的客户端api认证</a><a href="/posts/winter-vacation-daily">寒假日常</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"新浪微博登录第三方应用","date":1509204819000,"slug":"weibo-third-party-login","content":"\u003cp\u003e通过观察网易云音乐使用微博登录时跳转的页面\u003ca href=\"https://api.weibo.com/oauth2/authorize?client_id=301575942\u0026#x26;response_type=code\u0026#x26;redirect_uri=http://music.163.com/back/weibo\u0026#x26;forcelogin=true\u0026#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog\"\u003e应用授权-网易云音乐\u003c/a\u003e，在微博账号的输入栏被填写并失去焦点后，会发送一个到 prelogin.php 的请求，请求的 url 为\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ehttps://login.sina.com.cn/sso/prelogin.php?entry=openapi\u0026#x26;callback=sinaSSOController.preloginCallBack\u0026#x26;su=MTEx\u0026#x26;rsakt=mod\u0026#x26;checkpin=1\u0026#x26;client=ssologin.js(v1.4.18)\u0026#x26;_=1509178064363\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e其中请求参数\u003ccode\u003esu\u003c/code\u003e为 base64 编码的账号字符串，\u003ccode\u003e_\u003c/code\u003e为当前时间，这里用\u003ccode\u003eint(time.time()*1000)\u003c/code\u003e生成。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003estart_requests\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself\u003c/span\u003e):\u003c/span\u003e\r\n    username_quote = urllib.parse.quote_plus(self.username)\r\n    username_base64 = base64.b64encode(username_quote.encode(\u003cspan class=\"hljs-string\"\u003e\"utf-8\"\u003c/span\u003e))\r\n    su =  username_base64.decode(\u003cspan class=\"hljs-string\"\u003e\"utf-8\"\u003c/span\u003e)\r\n    prelogin_url = \u003cspan class=\"hljs-string\"\u003e'https://login.sina.com.cn/sso/prelogin.php?entry=openapi\u0026#x26;callback=sinaSSOController.preloginCallBack\u0026#x26;su=%s\u0026#x26;rsakt=mod\u0026#x26;checkpin=1\u0026#x26;client=ssologin.js(v1.4.18)\u0026#x26;_=%s'\u003c/span\u003e % (su,\u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e(time.time())))\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [scrapy.Request(prelogin_url,headers=self.headers,meta={\u003cspan class=\"hljs-string\"\u003e\"cookiejar\"\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e},callback=self.login_request)]\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e请求的返回结果为：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003esinaSSOController.preloginCallBack({\r\n  \u003cspan class=\"hljs-attr\"\u003eretcode\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eservertime\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1509178513\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003epcid\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"yf-db7f8e82296bf55717be22d63e61976356da\"\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003enonce\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"8GLRMV\"\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003epubkey\u003c/span\u003e:\r\n    \u003cspan class=\"hljs-string\"\u003e\"EB2A38568661887FA180BDDB5CABD5F21C7BFD59C090CB2D245A87AC253062882729293E5506350508E7F9AA3BB77F4333231490F915F6D63C55FE2F08A49B353F444AD3993CACC02DB784ABBB8E42A9B1BBFFFB38BE18D78E87A0E41B9B8F73A928EE0CCEE1F6739884B9777E4FE9E88A1BBE495927AC4A799B3181D6442443\"\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003ersakv\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"1330428213\"\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eis_openlock\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eshowpin\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eexectime\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e23\u003c/span\u003e,\r\n})\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用以下代码将其中的参数转换为一个 python 的 dict:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e    res = response.text.replace(\u003cspan class=\"hljs-string\"\u003e\"sinaSSOController.preloginCallBack\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e)\r\n    server_data = \u003cspan class=\"hljs-built_in\"\u003eeval\u003c/span\u003e(res)\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用得到的\u003ccode\u003eservertime\u003c/code\u003e、\u003ccode\u003enonce\u003c/code\u003e和\u003ccode\u003epubkey\u003c/code\u003e参数得出 RSA 加密后的密码：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e    rsaPublickey = \u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e(server_data[\u003cspan class=\"hljs-string\"\u003e'pubkey'\u003c/span\u003e], \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e)\r\n    key = rsa.PublicKey(rsaPublickey, \u003cspan class=\"hljs-number\"\u003e65537\u003c/span\u003e)\r\n    message = \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(server_data[\u003cspan class=\"hljs-string\"\u003e'servertime'\u003c/span\u003e]) + \u003cspan class=\"hljs-string\"\u003e'\\t'\u003c/span\u003e + \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(server_data[\u003cspan class=\"hljs-string\"\u003e'nonce'\u003c/span\u003e]) + \u003cspan class=\"hljs-string\"\u003e'\\n'\u003c/span\u003e + \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(self.password)\r\n    message = message.encode(\u003cspan class=\"hljs-string\"\u003e\"utf-8\"\u003c/span\u003e)\r\n    passwd = rsa.encrypt(message, key)\r\n    passwd = binascii.b2a_hex(passwd)\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e然后就可以发送登录请求了：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003elogin_url = \u003cspan class=\"hljs-string\"\u003e'https://login.sina.com.cn/sso/login.php?client=ssologin.js(v1.4.18)\u0026#x26;_=%s\u0026#x26;openapilogin=qrcode'\u003c/span\u003e % \u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003eint\u003c/span\u003e(time.time()))\r\nscrapy.FormRequest(\r\n    login_url,\r\n    meta={\u003cspan class=\"hljs-string\"\u003e'cookiejar'\u003c/span\u003e: response.meta[\u003cspan class=\"hljs-string\"\u003e'cookiejar'\u003c/span\u003e]},\r\n    headers=self.headers,\r\n    formdata={\r\n        \u003cspan class=\"hljs-string\"\u003e'entry'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'openapi'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'gateway'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'1'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'from'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'savestate'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'0'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'useticket'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'1'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'pagerefer'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'http://music.163.com/'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'ct'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'1800'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e's'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'1'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'vsnf'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'1'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'vsnval'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'door'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'appkey'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'u6BYq'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'su'\u003c/span\u003e:self.get_su(),\r\n        \u003cspan class=\"hljs-string\"\u003e'service'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'miniblog'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'servertime'\u003c/span\u003e:\u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(server_data[\u003cspan class=\"hljs-string\"\u003e'servertime'\u003c/span\u003e]),\r\n        \u003cspan class=\"hljs-string\"\u003e'nonce'\u003c/span\u003e:\u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(server_data[\u003cspan class=\"hljs-string\"\u003e'nonce'\u003c/span\u003e]),\r\n        \u003cspan class=\"hljs-string\"\u003e'pwencode'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'rsa2'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'rsakv'\u003c/span\u003e:\u003cspan class=\"hljs-built_in\"\u003estr\u003c/span\u003e(server_data[\u003cspan class=\"hljs-string\"\u003e'rsakv'\u003c/span\u003e]),\r\n        \u003cspan class=\"hljs-string\"\u003e'sp'\u003c/span\u003e:passwd,\r\n        \u003cspan class=\"hljs-string\"\u003e'sr'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'1366*768'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'encoding'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'UTF-8'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'cdult'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'2'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'domain'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'weibo.com'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'prelt'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'55'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'returntype'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'TEXT'\u003c/span\u003e\r\n    },\r\n    callback=self.authorize_request,\r\n)\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e然后是对网易云音乐的授权，请求表单需要提供登录成功返回的\u003ccode\u003eticket\u003c/code\u003e值：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-python\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eauthorize_request\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eself,response\u003c/span\u003e):\u003c/span\u003e\r\n    response_json = json.loads(response.text)\r\n    authorize_url = \u003cspan class=\"hljs-string\"\u003e'https://api.weibo.com/oauth2/authorize'\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e scrapy.FormRequest(authorize_url,\r\n        headers=self.headers,\r\n        meta={\u003cspan class=\"hljs-string\"\u003e'cookiejar'\u003c/span\u003e: response.meta[\u003cspan class=\"hljs-string\"\u003e'cookiejar'\u003c/span\u003e]},\r\n        formdata={\r\n            \u003cspan class=\"hljs-string\"\u003e'action'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'login'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'display'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'default'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'withOfficalFlag'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'0'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'quick_auth'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'false'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'withOfficalAccount'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'scope'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'ticket'\u003c/span\u003e:response_json[\u003cspan class=\"hljs-string\"\u003e'ticket'\u003c/span\u003e],\r\n            \u003cspan class=\"hljs-string\"\u003e'isLoginSina'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'response_type'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'code'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'regCallback'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'https://api.weibo.com/oauth2/authorize?client_id=301575942\u0026#x26;response_type=code\u0026#x26;redirect_uri=http://music.163.com/back/weibo\u0026#x26;forcelogin=true\u0026#x26;scope=friendships_groups_read,statuses_to_me_read,follow_app_official_microblog'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'redirect_uri'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'http://music.163.com/back/weibo'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'client_id'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'301575942'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'appkey62'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'u6BYq'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'state'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'verifyToken'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'null'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'from'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'switchLogin'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'0'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'userId'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'passwd'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e\r\n        },\r\n        callback=do_something)\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e授权成功后会跳转到\u003ccode\u003ehttp://music.163.com/back/sns\u003c/code\u003e,返回了网易云音乐用户的 uid 和一些信息，大功告成~\u003c/p\u003e"},"prev":{"slug":"Laravel-passport-for-api-auth","title":"使用laravel/passport的客户端api认证","date":1477604930000},"next":{"slug":"winter-vacation-daily","title":"寒假日常","date":1519837064000}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"weibo-third-party-login"},"buildId":"s2lQGLd0xJvTQahu6yiKS","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-a98cee78eb8282e29fb6.js"></script><script src="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.2113c6061a2f456066a1.js" async=""></script><script src="/_next/static/chunks/commons.f771efd637e54964f7dc.js" async=""></script><script src="/_next/static/chunks/pages/_app-ff7d19fcc1eef3597074.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" async=""></script><script src="/_next/static/s2lQGLd0xJvTQahu6yiKS/_buildManifest.js" async=""></script><script src="/_next/static/s2lQGLd0xJvTQahu6yiKS/_ssgManifest.js" async=""></script></body></html>