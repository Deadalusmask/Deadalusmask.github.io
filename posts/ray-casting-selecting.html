<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" type="image/png" href="/favicon.png"/><meta name="theme-color" content="#000000"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><meta name="image" content="/favicon.png"/><title>在WebGL中使用射线选择模型 -Arthas.me</title><meta property="og:url" content="https://arthas.me/posts/ray-casting-selecting"/><meta property="og:type" content="article"/><meta property="og:title" content="在WebGL中使用射线选择模型"/><meta property="og:image" content="/favicon.png"/><meta name="twitter:title" content="在WebGL中使用射线选择模型"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:image" content="/favicon.png"/><meta name="twitter:creator" content="@deadalusmask"/><meta name="next-head-count" content="15"/><link rel="preload" href="/_next/static/css/0a15d971913fef300597.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0a15d971913fef300597.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.2113c6061a2f456066a1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.f771efd637e54964f7dc.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7787517220261cbe4aba.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" as="script"/></head><body><div id="__next"><div class="page"><h3><a href="/">Arthas.me</a> / <a href="/posts">Posts</a> /</h3><h1>在WebGL中使用射线选择模型</h1><span>2018.8.22</span><div class="md-content"><p><a href="https://arthas.me/demo/ray-casting/index.html">DEMO</a></p>
<h2>思路</h2>
<p>首先要用到摄像机的位置、方向和鼠标在屏幕上的位置来得到射线的起点和方向，然后用得到的射线和模型的每个三角形测试来判断模型是否被选中。</p>
<h2>构建射线</h2>
<p>先实现简单的射线类：</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Ray</span></span><span class="token punctuation">(</span><span class="token parameter">position<span class="token punctuation">,</span> direction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">position</span> <span class="token operator">=</span> position
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">direction</span> <span class="token operator">=</span> direction
<span class="token punctuation">}</span>
</code></pre></div>
<p>通过<code class="language-unknown">camera.position</code>和<code class="language-unknown">camera.front</code>可以直接得到一个以摄像机为原地，朝向摄像机正前方的射线。
然后，根据摄像机的 fov 和鼠标的位置坐标可以计算出鼠标所指方向偏离中心的 x 轴和 y 轴角度。</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js">argl<span class="token punctuation">.</span><span class="token property-access">canvas</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> angleY <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">offsetY</span> <span class="token operator">*</span> camera<span class="token punctuation">.</span><span class="token property-access">zoom</span> <span class="token operator">/</span> argl<span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token property-access">zoom</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> zoomX <span class="token operator">=</span> <span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token property-access">zoom</span> <span class="token operator">/</span> argl<span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">height</span><span class="token punctuation">)</span> <span class="token operator">*</span> argl<span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">width</span>
  <span class="token keyword">let</span> angleX <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">offsetX</span> <span class="token operator">*</span> zoomX <span class="token operator">/</span> argl<span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">.</span><span class="token property-access">width</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>zoomX <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>接下来，再将朝向摄像机正前方的向量在<code class="language-unknown">camera.front</code>和<code class="language-unknown">camera.right</code>两个向量所在的平面中旋转<code class="language-unknown">angleX</code>度，再在旋转后的向量和<code class="language-unknown">camera.up</code>两个向量所在的平面中旋转<code class="language-unknown">angleY</code>度，就得到了鼠标所指向的方向。</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> normalFR <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">cross</span><span class="token punctuation">(</span>normalFR<span class="token punctuation">,</span> camera<span class="token punctuation">.</span><span class="token property-access">front</span><span class="token punctuation">,</span> camera<span class="token punctuation">.</span><span class="token property-access">right</span><span class="token punctuation">)</span>
glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">normalize</span><span class="token punctuation">(</span>normalFR<span class="token punctuation">,</span> normalFR<span class="token punctuation">)</span>

<span class="token keyword">let</span> direction <span class="token operator">=</span> <span class="token function">rotateVec</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token property-access">front</span><span class="token punctuation">,</span> normalFR<span class="token punctuation">,</span> glm<span class="token punctuation">.</span><span class="token property-access">glMatrix</span><span class="token punctuation">.</span><span class="token method function property-access">toRadian</span><span class="token punctuation">(</span>angleX<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> normalFU <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">cross</span><span class="token punctuation">(</span>normalFU<span class="token punctuation">,</span> direction<span class="token punctuation">,</span> camera<span class="token punctuation">.</span><span class="token property-access">up</span><span class="token punctuation">)</span>
glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">normalize</span><span class="token punctuation">(</span>normalFU<span class="token punctuation">,</span> normalFU<span class="token punctuation">)</span>

direction <span class="token operator">=</span> <span class="token function">rotateVec</span><span class="token punctuation">(</span>direction<span class="token punctuation">,</span> normalFU<span class="token punctuation">,</span> glm<span class="token punctuation">.</span><span class="token property-access">glMatrix</span><span class="token punctuation">.</span><span class="token method function property-access">toRadian</span><span class="token punctuation">(</span>angleY<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//平面内向量的旋转，normal为平面的法线，angle为旋转角度</span>
<span class="token keyword">function</span> <span class="token function">rotateVec</span><span class="token punctuation">(</span><span class="token parameter">vec<span class="token punctuation">,</span> normal<span class="token punctuation">,</span> angle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> direction <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> t1 <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> t2 <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">normalize</span><span class="token punctuation">(</span>normal<span class="token punctuation">,</span> normal<span class="token punctuation">)</span>

  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">scale</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> vec<span class="token punctuation">,</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">cross</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> normal<span class="token punctuation">,</span> vec<span class="token punctuation">)</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">scale</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> t2<span class="token punctuation">,</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>direction<span class="token punctuation">,</span> t1<span class="token punctuation">,</span> t2<span class="token punctuation">)</span>

  <span class="token keyword control-flow">return</span> direction
<span class="token punctuation">}</span>
</code></pre></div>
<p>然后就可以构建所需射线了：</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> ray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ray</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">,</span> direction<span class="token punctuation">)</span>
</code></pre></div>
<h2>射线三角形相交检测算法</h2>
<p>使用的算法为<a href="https://en.wikipedia.org/wiki/M%C3%B6ller%E2%80%93Trumbore_intersection_algorithm">Möller–Trumbore intersection algorithm</a></p>
<p>js 实现如下, 我将其作为 Ray 类的一个方法：</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token class-name">Ray</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">intersectsTriangle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">triangle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">EPSILON</span> <span class="token operator">=</span> <span class="token number">0.0000001</span>
  <span class="token keyword">let</span> edge1 <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> edge2 <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> h <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> s <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> q <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> a<span class="token punctuation">,</span> f<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
  <span class="token keyword">let</span> temp <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">sub</span><span class="token punctuation">(</span>edge1<span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">sub</span><span class="token punctuation">(</span>edge2<span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">cross</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">direction</span><span class="token punctuation">,</span> edge2<span class="token punctuation">)</span>
  a <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">dot</span><span class="token punctuation">(</span>edge1<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>a <span class="token operator">></span> <span class="token operator">-</span><span class="token constant">EPSILON</span> <span class="token operator">&#x26;&#x26;</span> a <span class="token operator">&#x3C;</span> <span class="token constant">EPSILON</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token boolean">false</span>
  f <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> a
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">sub</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">,</span> triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  u <span class="token operator">=</span> f <span class="token operator">*</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">dot</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>u <span class="token operator">&#x3C;</span> <span class="token number">0.0</span> <span class="token operator">||</span> u <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token boolean">false</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">cross</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> s<span class="token punctuation">,</span> edge1<span class="token punctuation">)</span>
  v <span class="token operator">=</span> f <span class="token operator">*</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">dot</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">direction</span><span class="token punctuation">,</span> q<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>v <span class="token operator">&#x3C;</span> <span class="token number">0.0</span> <span class="token operator">||</span> u <span class="token operator">+</span> v <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token boolean">false</span>
  <span class="token comment">// At this stage we can compute t to find out where the intersection point is on the line.</span>
  t <span class="token operator">=</span> f <span class="token operator">*</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">dot</span><span class="token punctuation">(</span>edge2<span class="token punctuation">,</span> q<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>t <span class="token operator">></span> <span class="token constant">EPSILON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ray intersection</span>
    <span class="token keyword">let</span> <span class="token maybe-class-name">IntersectionPoint</span> <span class="token operator">=</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">scale</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">direction</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
    glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token maybe-class-name">IntersectionPoint</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">direction</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token comment">// This means that there is a line intersection but not a ray intersection.</span>
  <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2>检测射线与模型是否相交</h2>
<p>通过循环，使用<code class="language-unknown">mesh.indices</code>和<code class="language-unknown">mesh.vertices</code>中的数据来构建每一个三角形，再将其坐标变换到世界空间，然后检测他们是否与射线相交</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> len <span class="token operator">=</span> suzanneMesh<span class="token punctuation">.</span><span class="token property-access">indices</span><span class="token punctuation">.</span><span class="token property-access">length</span>

<span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> len<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token punctuation">[</span>
    suzanneMesh<span class="token punctuation">.</span><span class="token property-access">indices</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
    suzanneMesh<span class="token punctuation">.</span><span class="token property-access">indices</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    suzanneMesh<span class="token punctuation">.</span><span class="token property-access">indices</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">let</span> triangle <span class="token operator">=</span> <span class="token punctuation">[</span>glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">transformMat4</span><span class="token punctuation">(</span>
    triangle<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    model
  <span class="token punctuation">)</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">transformMat4</span><span class="token punctuation">(</span>
    triangle<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    model
  <span class="token punctuation">)</span>
  glm<span class="token punctuation">.</span><span class="token property-access">vec3</span><span class="token punctuation">.</span><span class="token method function property-access">transformMat4</span><span class="token punctuation">(</span>
    triangle<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      suzanneMesh<span class="token punctuation">.</span><span class="token property-access">vertices</span><span class="token punctuation">[</span>index<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    model
  <span class="token punctuation">)</span>

  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>ray<span class="token punctuation">.</span><span class="token method function property-access">intersectsTriangle</span><span class="token punctuation">(</span>triangle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flag <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>然后即可利用布尔值<code class="language-unknown">flag</code>来添加是否选中模型的效果了，demo 中选中时模型变成红色。</p>
<h2>完整代码</h2>
<p><a href="https://github.com/Deadalusmask/ArGL/tree/master/examples/pick_test">Deadalusmask/ArGL/examples/pick_test</a></p>
<p><a href="https://arthas.me/demo/ray-casting/index.html">DEMO</a></p></div><hr class="hr"/><div style="display:flex;justify-content:space-between"><a style="margin-right:24px" href="/posts/Graphic-Basics-3">Graphic Basics 3 着色器</a><a href="/posts/global-state-with-hooks">Global state with hooks</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"在WebGL中使用射线选择模型","date":1534877523000,"slug":"ray-casting-selecting","content":"\u003cp\u003e\u003ca href=\"https://arthas.me/demo/ray-casting/index.html\"\u003eDEMO\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003e思路\u003c/h2\u003e\n\u003cp\u003e首先要用到摄像机的位置、方向和鼠标在屏幕上的位置来得到射线的起点和方向，然后用得到的射线和模型的每个三角形测试来判断模型是否被选中。\u003c/p\u003e\n\u003ch2\u003e构建射线\u003c/h2\u003e\n\u003cp\u003e先实现简单的射线类：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003e\u003cspan class=\"token maybe-class-name\"\u003eRay\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eposition\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e direction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eposition\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e position\n  \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edirection\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e direction\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e通过\u003ccode class=\"language-unknown\"\u003ecamera.position\u003c/code\u003e和\u003ccode class=\"language-unknown\"\u003ecamera.front\u003c/code\u003e可以直接得到一个以摄像机为原地，朝向摄像机正前方的射线。\n然后，根据摄像机的 fov 和鼠标的位置坐标可以计算出鼠标所指方向偏离中心的 x 轴和 y 轴角度。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003eargl\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecanvas\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'mousemove'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ee\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e angleY \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eoffsetY\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e camera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ezoom\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e argl\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eoptions\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eheight\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecamera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ezoom\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e zoomX \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecamera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ezoom\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e argl\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eoptions\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eheight\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e argl\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eoptions\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ewidth\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e angleX \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eoffsetX\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e zoomX \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e argl\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eoptions\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ewidth\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ezoomX \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e接下来，再将朝向摄像机正前方的向量在\u003ccode class=\"language-unknown\"\u003ecamera.front\u003c/code\u003e和\u003ccode class=\"language-unknown\"\u003ecamera.right\u003c/code\u003e两个向量所在的平面中旋转\u003ccode class=\"language-unknown\"\u003eangleX\u003c/code\u003e度，再在旋转后的向量和\u003ccode class=\"language-unknown\"\u003ecamera.up\u003c/code\u003e两个向量所在的平面中旋转\u003ccode class=\"language-unknown\"\u003eangleY\u003c/code\u003e度，就得到了鼠标所指向的方向。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e normalFR \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nglm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecross\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enormalFR\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e camera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003efront\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e camera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eright\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nglm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003enormalize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enormalFR\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e normalFR\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e direction \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erotateVec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecamera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003efront\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e normalFR\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eglMatrix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etoRadian\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eangleX\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e normalFU \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nglm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecross\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enormalFU\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e direction\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e camera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nglm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003enormalize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enormalFU\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e normalFU\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\ndirection \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erotateVec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edirection\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e normalFU\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eglMatrix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etoRadian\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eangleY\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e//平面内向量的旋转，normal为平面的法线，angle为旋转角度\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003erotateVec\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003evec\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e normal\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e angle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e direction \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e t1 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e t2 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003enormalize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enormal\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e normal\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003escale\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e vec\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eMath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecos\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eangle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecross\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e normal\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e vec\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003escale\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e t2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eMath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eangle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edirection\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e t1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e t2\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e direction\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e然后就可以构建所需射线了：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e ray \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eRay\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecamera\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eposition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e direction\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e射线三角形相交检测算法\u003c/h2\u003e\n\u003cp\u003e使用的算法为\u003ca href=\"https://en.wikipedia.org/wiki/M%C3%B6ller%E2%80%93Trumbore_intersection_algorithm\"\u003eMöller–Trumbore intersection algorithm\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003ejs 实现如下, 我将其作为 Ray 类的一个方法：\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token class-name\"\u003eRay\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eprototype\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method-variable function-variable method function property-access\"\u003eintersectsTriangle\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003etriangle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token constant\"\u003eEPSILON\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.0000001\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e edge1 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e edge2 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e h \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e s \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e q \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e f\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e u\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e v\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e t\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e temp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esub\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eedge1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esub\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eedge2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecross\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eh\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edirection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e edge2\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003edot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eedge1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e h\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token constant\"\u003eEPSILON\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token constant\"\u003eEPSILON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n  f \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e a\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esub\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003es\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eposition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  u \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e f \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003edot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003es\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e h\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eu \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.0\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e u \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e1.0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecross\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eq\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e s\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e edge1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  v \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e f \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003edot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edirection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e q\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ev \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.0\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e u \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e v \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e1.0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// At this stage we can compute t to find out where the intersection point is on the line.\u003c/span\u003e\n  t \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e f \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003edot\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eedge2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e q\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token constant\"\u003eEPSILON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// ray intersection\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eIntersectionPoint\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003escale\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etemp\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edirection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eadd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token maybe-class-name\"\u003eIntersectionPoint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eposition\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edirection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// This means that there is a line intersection but not a ray intersection.\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e检测射线与模型是否相交\u003c/h2\u003e\n\u003cp\u003e通过循环，使用\u003ccode class=\"language-unknown\"\u003emesh.indices\u003c/code\u003e和\u003ccode class=\"language-unknown\"\u003emesh.vertices\u003c/code\u003e中的数据来构建每一个三角形，再将其坐标变换到世界空间，然后检测他们是否与射线相交\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e flag \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e len \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eindices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003elength\u003c/span\u003e\n\n\u003cspan class=\"token keyword control-flow\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e len\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e index \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eindices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eindices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eindices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e triangle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eglm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etransformMat4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    model\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etransformMat4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    model\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  glm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evec3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etransformMat4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    triangle\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      suzanneMesh\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evertices\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eindex\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    model\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eray\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eintersectsTriangle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etriangle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    flag \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e然后即可利用布尔值\u003ccode class=\"language-unknown\"\u003eflag\u003c/code\u003e来添加是否选中模型的效果了，demo 中选中时模型变成红色。\u003c/p\u003e\n\u003ch2\u003e完整代码\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/Deadalusmask/ArGL/tree/master/examples/pick_test\"\u003eDeadalusmask/ArGL/examples/pick_test\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://arthas.me/demo/ray-casting/index.html\"\u003eDEMO\u003c/a\u003e\u003c/p\u003e"},"prev":{"slug":"Graphic-Basics-3","title":"Graphic Basics 3 着色器","date":1525119270000},"next":{"slug":"global-state-with-hooks","title":"Global state with hooks","date":1562871240000}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"ray-casting-selecting"},"buildId":"1EFwxkPp7d779ZeTLfDNk","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-a98cee78eb8282e29fb6.js"></script><script src="/_next/static/chunks/main-67279fe62e81e3dbb4fe.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.2113c6061a2f456066a1.js" async=""></script><script src="/_next/static/chunks/commons.f771efd637e54964f7dc.js" async=""></script><script src="/_next/static/chunks/pages/_app-7787517220261cbe4aba.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-44fb0cf09ad137619ef8.js" async=""></script><script src="/_next/static/1EFwxkPp7d779ZeTLfDNk/_buildManifest.js" async=""></script><script src="/_next/static/1EFwxkPp7d779ZeTLfDNk/_ssgManifest.js" async=""></script></body></html>